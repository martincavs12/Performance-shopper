<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Reporte de Performance - PedidosYa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; margin: 0; background: #f4f4f4; color: #100423; }
        .container { max-width: 960px; margin: 2rem auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h2 { color: #ea044e; text-align: center; margin-bottom: 1.5rem; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333; }
        select, input, button { width: calc(100% - 22px); margin: 10px 0; padding: 10px; font-family: inherit; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { background: #ea044e; color: white; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.3s ease; }
        button:hover { background: #d40344; }
        .card { border: 2px solid #ccc; padding: 20px; margin: 20px 0; border-radius: 10px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .oro { background: #fff4cc; border-color: #ffcc00; }
        .plata { background: #cfe2f3; border-color: #6cbde2; }
        .bronce { background: #f2e2d2; border-color: #d18d42; }
        .critico { background: #f8d7da; border-color: #dc3545; }
        .hidden { display: none; }
        strong { display: inline-block; width: 180px; }
        h3 { color: #100423; margin-top: 0; margin-bottom: 1em; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        h4 { margin-top: 1.5em; margin-bottom: 0.5em; color: #000; font-size: 1rem; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 4px; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        table th, table td { border: 1px solid #ddd; padding: 12px 8px; text-align: center; vertical-align: middle; }
        table th { background: #e9ecef; font-weight: 700; color: #495057; }
        table tr:nth-child(even) { background-color: #f8f9fa; }
        table tr:hover { background-color: #f1f1f1; }
        #mensaje { color: #ea044e; text-align: center; font-weight: 600; margin-top: 15px; }
        .op-block { margin: 12px 0 4px; }
        .op-label { font-weight: 700; margin-bottom: 6px; }
        .op-pillar { margin: 10px 0 14px; }
        .op-title { font-weight: 700; color:#100423; margin-bottom: 6px; display:flex; align-items:center; gap:8px; }
        .op-ico { width: 1.25rem; display:inline-block; text-align:center; }
        .op-list { margin: 0; padding-left: 22px; }
        .op-list li { margin: 3px 0; text-align: left; }
        .card ul { margin:0; }
        .delta { font-weight: 700; margin-left: 4px; }
        .delta.good { color: #0a8f3d; }
        .delta.bad  { color: #c0392b; }
        .banner-novedad{
  margin: 12px 0 18px;
  padding: 12px 14px;
  border-radius: 10px;
  background: #eaf8ff;
  border: 1px solid #b9e3ff;
  color: #083b55;
  font-weight: 600;
}
.banner-novedad a{
  color: #0a5ea8;
  text-decoration: underline;
}
        .banner-info {
  margin: 12px 0 18px;
  padding: 12px 14px;
  border-radius: 10px;
  background: #EAF7EE; /* Verde claro*/
  border: 1px solid #B8E1C6;
  color: #215A36; /* Texto oscuro */
  font-weight: 600;
}
.banner-info a {
  color: #0F5132;
  text-decoration: underline;
}
/* Esto es para que la etiqueta <strong> no se rompa dentro del banner */
.banner-info strong {
    width: auto; 
    display: inline;
}
    </style>
</head>
<body>
    <div class="container" id="login">
        <h2>Acceso al Reporte</h2>
        <input type="text" id="usuario" placeholder="Usuario" />
        <input type="password" id="contrasena" placeholder="Contraseña" />
        <button onclick="validarLogin()">Ingresar</button>
        <p id="error" style="color: red; text-align: center; margin-top: 10px;"></p>
    </div>

    <div class="container hidden" id="app">
        <h2>Reporte de Performance</h2>
        <div id="bannerNovedad" class="banner-novedad hidden"></div>
        <div id="bannerAdicional" class="banner-info hidden"></div>
        <label for="pais">País</label>
        <select id="pais" disabled><option value="">Seleccionar</option></select>
        
        <label for="franquicia">Franquicia</label>
        <select id="franquicia"><option value="">Seleccionar</option></select>
        
        <label for="sucursal">Sucursal</label>
        <select id="sucursal"><option value="">Seleccionar</option></select>
        
        <label for="semana">Semana</label>
        <select id="semana"><option value="">Seleccionar</option></select>
        
        <label for="shopper">Shopper</label>
        <select id="shopper"><option value="">Todos</option></select>
        
        <p id="mensaje"></p>
        
        <div id="cortes"></div>
        <div id="overallScore" class="card hidden"></div>
        <div id="resultado"></div>
    </div>

    <script>
        /* ========= Helpers de URLs ========= */
        const SHEET_DOC_ID = "1jA3czu0ZOQdV0d7HF4dN2xxTPmi2a-zUdCmKNVG2hgg";
        const csvByGid = (gid) =>
          `https://docs.google.com/spreadsheets/d/${SHEET_DOC_ID}/export?format=csv&gid=${gid}&_=${Date.now()}`;
        /* =================================== */

        let userPaisDisplayName = ""; 
        let userPaisNormalized = ""; 
        let data = [], overall = [], clusterData = [];

        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
        }

        /* ==== Sanitización y logging seguro ==== */
        const URL_RE = /https?:\/\/[^\s)]+/g;
        function sanitize(text) { return String(text || '').replace(URL_RE, '[URL oculta]'); }
        function safeWarn(label, details) { try { console.warn(`Aviso en ${label}`, sanitize(details)); } catch(_){} }
        function safeError(label, err) {
          try {
            const msg = err && (err.stack || err.message || String(err));
            console.error(`Error en ${label}:`, sanitize(msg));
          } catch(_) {}
        }
        // Ocultar URLs también en errores globales
        window.addEventListener('error', (e) => {
          safeError('GLOBAL', e?.error || e?.message || 'Error');
        });
        window.addEventListener('unhandledrejection', (e) => {
          safeError('GLOBAL Promise', e?.reason || 'Rechazo no manejado');
        });

        /* ==== Utilidades de lectura/variaciones ==== */
        function escapeHTML(s='') {
          return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
        }
        function getVal(row, keys, fallback='-') {
          for (const k of keys) {
            const v = row[k + '_display'];
            if (v !== undefined && v !== null && String(v).trim() !== '') return v;
          }
          return fallback;
        }
        const DELTA_RULE = {
          var_shopper_scoring: 'upGood',
          var_timing_compliance: 'upGood',
          var_picking_compliance: 'upGood',
          var_quality_compliance: 'upGood',
          var_rep_sent: 'upGood',
          var_rep_rate: 'upGood',
          var_first_prod_time_puntos: 'downGood',
          var_picking_time_puntos: 'downGood',
          var_VFR: 'downGood',
          var_OOS_FR: 'downGood',
          var_not_found_rate: 'downGood',
          var_missing_item: 'downGood',
          var_wrong_item: 'downGood',
          var_prod_quality: 'downGood',
          var_picking_late: 'downGood',
          var_first_prod_late: 'downGood',
        };
        // ⭐ NUEVO: Lista de métricas que NO llevan el signo de porcentaje
const METRICAS_SIN_PORCENTAJE = new Set([
    'var_first_prod_time_puntos',
    'var_picking_time_puntos'
]);
        function parseDeltaNumber(s) {
          if (s === null || s === undefined) return null;
          let t = String(s).trim().replace(/\u2212/g, '-').replace(',', '.');
          const m = t.match(/[-+]?(\d+(\.\d+)?)/);
          return m ? parseFloat(m[0]) : NaN;
        }
        function formatDelta(row, varKey) {const raw = row[varKey + '_display'];
    if (raw === undefined || raw === null || String(raw).trim() === '') return '';

    const n = parseDeltaNumber(raw);
    // 1. Corregido: Mostrar también si la variación es 0
    if (!isFinite(n)) return '';

    // 2. Corregido: Determinar si se agrega el signo %
    const sufijo = METRICAS_SIN_PORCENTAJE.has(varKey) ? '' : '%';
    const valorMostrado = escapeHTML(String(raw).trim()) + sufijo;

    // Lógica para mostrar 0 con un ícono neutral
    if (n === 0) {
        return ` <span class="delta">(↔ ${valorMostrado})</span>`;
    }

    const rule = DELTA_RULE[varKey] || 'upGood';
    const isUp = n > 0;
    const isGood = rule === 'downGood' ? (n < 0) : (n > 0);
    const arrow = isUp ? '↑' : '↓';
    const cls = isGood ? 'good' : 'bad';
    return ` <span class="delta ${cls}">(${arrow} ${valorMostrado})</span>`;
        }

        const USERS = {
            "argentina": { user: "arg", pass: "arg" },
            "bolivia": { user: "bol", pass: "bol" },
            "guatemala": { user: "gua", pass: "gua" },
            "honduras": { user: "hon", pass: "hon" },
            "panamá": { user: "pan", pass: "pan" },
            "perú": { user: "per", pass: "per" },
            "República Dominicana": { user: "rep", pass: "rep" },
            "ecuador": { user: "ecu", pass: "ecu" },
            "uruguay": { user: "uru", pass: "uru" }
        };
// URL del instructivo (Drive)
const PDF_URL = "https://drive.google.com/file/d/1F1TDRak4iPKly98hPAEZxMMQDIbp22cA/view";

// Países EXCLUIDOS del banner (usar SIEMPRE normalizados)
const EXCLUDED_BANNER = new Set(["panama", "republica dominicana"]);

function showNovedadBanner(){
  const el = document.getElementById("bannerNovedad");
  if (!el) return;

  // Mostramos a todos EXCEPTO Panamá y República Dominicana
  if (!EXCLUDED_BANNER.has(userPaisNormalized)) {
    el.innerHTML = `
      📢Novedad: ya puedes enviar sugerencias pesables para los productos faltantes que sean pesables.
      ¡Consulta más detalles <a href="${PDF_URL}" target="_blank" rel="noopener">aquí</a>!
    `;
    el.classList.remove("hidden");
  } else {
    el.classList.add("hidden");
  }
}
/* INICIO de la nueva función para la encuesta */
function showBannerAdicional() {
  const el = document.getElementById("bannerAdicional");
  if (!el) return;

  // Si no querés mostrar nada para ciertos países, podés seguir usando esta lógica,
  // pero como es un "gracias", normalmente se lo mostramos a todos los que participaron.
  // Ej: ocultar solo Uruguay:
  const OCULTAR_PAISES = new Set(["uruguay"]);
  if (OCULTAR_PAISES.has(userPaisNormalized)) {
    el.classList.add("hidden");
    return;
  }

  el.innerHTML = `
    🙌 <strong>¡Gracias por compartir tu experiencia!</strong>
    Vamos a analizar las respuestas con el equipo para trabajar en oportunidades de mejora y seguir construyendo una mejor experiencia para todos.
  `;
  el.classList.remove("hidden");
}
/* FIN de la nueva función */

        function validarLogin() {
            const u = document.getElementById("usuario").value.toLowerCase();
            const p = document.getElementById("contrasena").value.toLowerCase();
            
            const found = Object.entries(USERS).find(([paisKey, cred]) => {
                return normalizeString(cred.user) === normalizeString(u) && normalizeString(cred.pass) === normalizeString(p);
            });

            if (found) {
                userPaisDisplayName = found[0]; 
                userPaisNormalized = normalizeString(found[0]); 

                document.getElementById("login").classList.add("hidden");
                document.getElementById("app").classList.remove("hidden");
                document.getElementById("pais").innerHTML = `<option value="${userPaisDisplayName}">${userPaisDisplayName}</option>`;
                showNovedadBanner();
                showBannerAdicional();
                cargarDatos();
            } else {
                document.getElementById("error").textContent = "Credenciales incorrectas";
            }
        }

        /* ========== Render de Oportunidades ========== */
        function getPillarIcon(title) {
          const t = (title||'').toLowerCase();
          if (t.includes('picking')) return '🛒';
          if (t.includes('tiempos')) return '⏱️';
          return '✅';
        }
        function renderOportunidadHTML(raw) {
          if (!raw || /sin desvio|sin desvío|sin desvíos/i.test(raw)) {
            return '<div class="op-block"><div class="op-label">Puntos a Mejorar:</div><em>Sin desvíos relevantes</em></div>';
          }
          let text = String(raw).replace(/<br\s*\/?>/gi, '\n').replace(/\r/g, '').trim();
          const pillarChunks = text.split(/\s*\|\s*|\n{2,}/).map(x => x.trim()).filter(Boolean);
          const looksLikePillars = pillarChunks.some(p => /^(\s*)?(Picking|Tiempos|Calidad)\s*:/i.test(p));
          if (!looksLikePillars) {
            return `<div class="op-block"><div class="op-label">Puntos a Mejorar:</div>${escapeHTML(text).replace(/\n/g,'<br>')}</div>`;
          }
          const htmlPillars = pillarChunks.map(chunk => {
            const m = chunk.match(/^\s*(Picking|Tiempos|Calidad)\s*:\s*(.*)$/i);
            if (!m) return '';
            const title = m[1];
            const body  = m[2] || '';
            const items = body.split(/;|\n/).map(s => s.replace(/^•\s*/,'').trim()).filter(Boolean);
            const li = items.map(it => `<li>${escapeHTML(it)}</li>`).join('');
            const list = li ? `<ul class="op-list">${li}</ul>` : `<ul class="op-list"><li>Por debajo del mínimo de ${title.toLowerCase()}</li></ul>`;
            return `<div class="op-pillar"><div class="op-title"><span class="op-ico">${getPillarIcon(title)}</span>${title}</div>${list}</div>`;
          }).join('');
          return `<div class="op-block"><div class="op-label">Puntos a Mejorar:</div>${htmlPillars}</div>`;
        }
        /* ========================================================================== */

        function aplicarFiltros() {
            const franquicia = document.getElementById("franquicia").value;
            const sucursal = document.getElementById("sucursal").value;
            const semana = document.getElementById("semana").value;
            const shopper = document.getElementById("shopper").value;
            
            const normalizedFranquicia = normalizeString(franquicia);
            const normalizedSucursal = normalizeString(sucursal);
            const normalizedSemana = normalizeString(semana);
            const normalizedShopper = normalizeString(shopper);
            
            const filteredDataForFranchise = data.filter(r => r.country_name === userPaisNormalized);
            const franquicias = new Set(filteredDataForFranchise.map(r => r.franchise_name_display).filter(Boolean));
            actualizarSelect("franquicia", franquicias);

            const filteredDataForSucursal = filteredDataForFranchise.filter(r =>
                (!franquicia || r.franchise_name === normalizedFranquicia)
            );
            const sucursales = new Set(filteredDataForSucursal.map(r => r.partner_name_display).filter(Boolean));
            actualizarSelect("sucursal", sucursales);

            const filteredDataForSemana = filteredDataForSucursal.filter(r =>
                (!sucursal || r.partner_name === normalizedSucursal)
            );
            const semanas = new Set(filteredDataForSemana.map(r => r.semana_display).filter(Boolean));
            actualizarSelect("semana", semanas);

            const filteredDataForShopper = filteredDataForSemana.filter(r =>
                (!semana || r.semana === normalizedSemana)
            );
            const shoppers = new Set(filteredDataForShopper.map(r => r.shopper_name_display).filter(Boolean));
            actualizarSelect("shopper", shoppers, true);

            mostrarCortes();
            mostrarResultados();
        }

        function actualizarSelect(id, valores, incluirTodos = false) {
            const el = document.getElementById(id);
            const actualValue = el.value;
            const normalizedActualValue = normalizeString(actualValue);
            el.innerHTML = incluirTodos ? `<option value="">Todos</option>` : `<option value="">Seleccionar</option>`;
            [...valores].sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b, undefined, {sensitivity: 'base'});
            }).forEach(v => {
                const o = document.createElement("option");
                o.value = v; o.textContent = v; el.appendChild(o);
            });
            const optionExists = Array.from(el.options).some(opt => normalizeString(opt.value) === normalizedActualValue);
            if (optionExists) el.value = actualValue;
            else if (incluirTodos && normalizedActualValue === '') el.value = "";
            else el.value = el.options[0].value;
        }

     function mostrarResultados() {
            const franquicia = document.getElementById("franquicia").value;
            const sucursal = document.getElementById("sucursal").value;
            const semana = document.getElementById("semana").value;
            const shopper = document.getElementById("shopper").value;

            const cont = document.getElementById("resultado");
            const msg = document.getElementById("mensaje");
            const overallScoreDiv = document.getElementById("overallScore");
            
            cont.innerHTML = "";
            msg.textContent = "";
            overallScoreDiv.classList.add("hidden");

            const normalizedFranquicia = normalizeString(franquicia);
            const normalizedSucursal = normalizeString(sucursal);
            const normalizedSemana = normalizeString(semana);
            const normalizedShopper = normalizeString(shopper);

            if (!sucursal || !semana) {
                msg.textContent = "Completá los filtros de Sucursal y Semana para ver resultados.";
                return;
            }

            /* -------- Tarjeta OVERALL (tienda) -------- */
            const storeOverall = overall.find(r =>
                r.country_name === userPaisNormalized &&
                r.partner_name === normalizedSucursal &&
                r.semana === normalizedSemana &&
                (!franquicia || r.franchise_name === normalizedFranquicia)
            );

            if (storeOverall) {
                const oppOverallHTML = renderOportunidadHTML(storeOverall.oportunidad_de_mejora_display || '');
                overallScoreDiv.innerHTML = `
                <h3>Puntaje General de la Tienda (${storeOverall.partner_name_display || '-'})</h3>
                <p><strong>Puntaje:</strong> ${getVal(storeOverall, ['shopper_scoring'])}${formatDelta(storeOverall, 'var_shopper_scoring')}</p>
                <p><strong>Posición:</strong> ${storeOverall.cluster_name_final_display || '-'}</p>
                <p><strong>Órdenes canceladas:</strong> ${getVal(storeOverall, ['VFR'])}${formatDelta(storeOverall, 'var_VFR')}</p>
                ${oppOverallHTML}
                
                <h4>TIEMPOS</h4>
                <p><strong>Puntaje Tiempos:</strong> ${getVal(storeOverall, ['timing_compliance'])}${formatDelta(storeOverall, 'var_timing_compliance')}</p>
                <p><strong>Tiempo por orden:</strong> ${getVal(storeOverall, ['picking_time'])}${formatDelta(storeOverall, 'var_picking_time_puntos')}</p>
                <p><strong>%Órdenes tarde:</strong> ${getVal(storeOverall, ['picking_late'])}${formatDelta(storeOverall, 'var_picking_late')}</p>
                <p><strong>Tiempo en encontrar primer item:</strong> ${getVal(storeOverall, ['first_prod_time'])}${formatDelta(storeOverall, 'var_first_prod_time_puntos')}</p>
                <p><strong>%Primer item encontrado > 3':</strong> ${getVal(storeOverall, ['first_prod_late'])}${formatDelta(storeOverall, 'var_first_prod_late')}</p>
                
                <h4>PICKING</h4>
                <p><strong>Puntaje Picking:</strong> ${getVal(storeOverall, ['picking_compliance'])}${formatDelta(storeOverall, 'var_picking_compliance')}</p>
                <p><strong>%Cancelaciones por falta de producto:</strong> ${getVal(storeOverall, ['OOS_FR'])}${formatDelta(storeOverall, 'var_OOS_FR')}</p>
                <p><strong>%Productos no encontrados:</strong> ${getVal(storeOverall, ['not_found_rate'])}${formatDelta(storeOverall, 'var_not_found_rate')}</p>
                <p><strong>%Reemplazos enviados:</strong> ${getVal(storeOverall, ['rep_sent'])}${formatDelta(storeOverall, 'var_rep_sent')}</p>
                <p><strong>%Reemplazos aceptados:</strong> ${getVal(storeOverall, ['rep_rate'])}${formatDelta(storeOverall, 'var_rep_rate')}</p>
                
                <h4>CALIDAD</h4>
                <p><strong>Puntaje Calidad:</strong> ${getVal(storeOverall, ['quality_compliance'])}${formatDelta(storeOverall, 'var_quality_compliance')}</p>
                <p><strong>%Falta producto:</strong> ${getVal(storeOverall, ['missing_item'])}${formatDelta(storeOverall, 'var_missing_item')}</p>
                <p><strong>%Producto en mal estado:</strong> ${getVal(storeOverall, ['prod_quality'])}${formatDelta(storeOverall, 'var_prod_quality')}</p>
                <p><strong>%Producto equivocado:</strong> ${getVal(storeOverall, ['wrong_item'])}${formatDelta(storeOverall, 'var_wrong_item')}</p>
              `;
                overallScoreDiv.classList.remove("hidden");
                overallScoreDiv.classList.remove("oro", "plata", "bronce", "critico");
                overallScoreDiv.classList.add(getColor(storeOverall.cluster_name_final_display));
            } else {
                overallScoreDiv.classList.add("hidden");
            }

            /* -------- Cards de SHOPPERS -------- */
            const filtrados = data.filter(r => {
                return r.country_name === userPaisNormalized &&
                       (!franquicia || r.franchise_name === normalizedFranquicia) &&
                       r.partner_name === normalizedSucursal &&
                       r.semana === normalizedSemana &&
                       (shopper === "" || r.shopper_name === normalizedShopper);
            });

            if (filtrados.length === 0 && !storeOverall) {
                msg.textContent = "No se encontraron resultados para los filtros seleccionados.";
                return;
            }

            if (shopper !== "") {
              const shopperData = filtrados.find(r => r.shopper_name === normalizedShopper);
              if (shopperData) {
                cont.appendChild(crearCard(shopperData, shopperData.shopper_name_display));
              } else {
                msg.textContent = "No se encontraron datos para el shopper seleccionado.";
              }
            } else {
              filtrados.forEach(r => cont.appendChild(crearCard(r, r.shopper_name_display)));
            }
        }
function crearCard(r, titulo) {
            const div = document.createElement("div");
            div.className = "card " + getColor(r.cluster_name_final_display); 
            const oppHTML = renderOportunidadHTML(r.oportunidad_de_mejora_display || '');

            div.innerHTML = `
                <h3>${titulo || '-'}</h3>
                <p><strong>Puntaje:</strong> ${getVal(r, ['shopper_scoring'])}${formatDelta(r, 'var_shopper_scoring')}</p>
                <p><strong>Posición:</strong> ${r.cluster_name_final_display || '-'}</p>
                <p><strong>Nivel de Experiencia:</strong> ${r.nivel_experiencia_display || '-'}</p>
              
                ${oppHTML}
                <p><strong>Semana:</strong> ${r.semana_display || '-'}</p>

                <h4>TIEMPOS</h4>
                <p><strong>Puntaje Tiempos:</strong> ${getVal(r, ['timing_compliance'])}${formatDelta(r, 'var_timing_compliance')}</p>
                <p><strong>Tiempo por orden:</strong> ${getVal(r, ['picking_time'])}${formatDelta(r, 'var_picking_time_puntos')}</p>
                <p><strong>%Órdenes tarde:</strong> ${getVal(r, ['picking_late'])}${formatDelta(r, 'var_picking_late')}</p>
                <p><strong>Tiempo en encontrar primer item:</strong> ${getVal(r, ['first_prod_time'])}${formatDelta(r, 'var_first_prod_time_puntos')}</p>
                <p><strong>%Primer item encontrado > 3':</strong> ${getVal(r, ['first_prod_late'])}${formatDelta(r, 'var_first_prod_late')}</p>

                <h4>PICKING</h4>
                <p><strong>Puntaje Picking:</strong> ${getVal(r, ['picking_compliance'])}${formatDelta(r, 'var_picking_compliance')}</p>
                <p><strong>%Cancelaciones por falta de producto:</strong> ${getVal(r, ['OOS_FR'])}${formatDelta(r, 'var_OOS_FR')}</p>
                <p><strong>%Productos no encontrados:</strong> ${getVal(r, ['not_found_rate'])}${formatDelta(r, 'var_not_found_rate')}</p>
                <p><strong>%Reemplazos enviados:</strong> ${getVal(r, ['rep_sent'])}${formatDelta(r, 'var_rep_sent')}</p>
                <p><strong>%Reemplazos aceptados:</strong> ${getVal(r, ['rep_rate'])}${formatDelta(r, 'var_rep_rate')}</p>

                <h4>CALIDAD</h4>
                <p><strong>Puntaje Calidad:</strong> ${getVal(r, ['quality_compliance'])}${formatDelta(r, 'var_quality_compliance')}</p>
                <p><strong>%Falta producto:</strong> ${getVal(r, ['missing_item'])}${formatDelta(r, 'var_missing_item')}</p>
                <p><strong>%Producto en mal estado:</strong> ${getVal(r, ['prod_quality'])}${formatDelta(r, 'var_prod_quality')}</p>
                <p><strong>%Producto equivocado:</strong> ${getVal(r, ['wrong_item'])}${formatDelta(r, 'var_wrong_item')}</p>
            `;
            return div;
        }
    

        function getColor(pos) {
            if (!pos) return '';
            const normalizedPos = normalizeString(pos);
            if (normalizedPos.includes("plata")) return "plata";
            if (normalizedPos.includes("oro")) return "oro";
            if (normalizedPos.includes("bronce")) return "bronce";
            if (normalizedPos.includes("critico") || normalizedPos.includes("crítico")) return "critico";
            return '';
        }

        function mostrarCortes() {
            const franquicia = document.getElementById("franquicia").value;
            const cont = document.getElementById("cortes");
            cont.innerHTML = "";

            if (!userPaisNormalized) return;

            let rows = [];
            let title = "";
            const normalizedFranquicia = normalizeString(franquicia);

            if (franquicia) { 
                rows = clusterData.filter(r => 
                    r.country_name === userPaisNormalized && 
                    r.franchise_name === normalizedFranquicia
                );
                title = `Condiciones por Posición (${franquicia})`;
            }

            if (rows.length === 0) {
                rows = clusterData.filter(r => 
                    r.country_name === userPaisNormalized && 
                    (!r.franchise_name || r.franchise_name === '')
                ); 
                title = `Condiciones por Posición (${userPaisDisplayName})`; 
            }

            if (!rows.length) {
                cont.innerHTML = "<p>No se encontraron condiciones de cortes para este país o franquicia.</p>";
                return;
            }

            let html = `<h3>${title}</h3>`;
            html += `<table style="width:100%;">
                <thead>
                    <tr>
                        <th>Posición</th>
                        <th>Puntaje</th>
                        <th>Tiempos Mínimo</th>
                        <th>Picking Mínimo</th>
                        <th>Calidad Mínimo</th>
                    </tr>
                </thead><tbody>`;
            rows.forEach(r => {
                html += `<tr>
                    <td>${r.cluster_name_display || '-'}</td>
                    <td>${(r.lower_bound_display !== undefined && r.lower_bound_display !== null ? r.lower_bound_display : '-')} - ${(r.upper_bound_display !== undefined && r.upper_bound_display !== null ? r.upper_bound_display : '-')}</td>
                    <td>${r.min_timing_compliance_display || '-'}</td>
                    <td>${r.min_picking_compliance_display || '-'}</td>
                    <td>${r.min_quality_compliance_display || '-'}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            cont.innerHTML = html;
        }

        function cargarDatos() {
            const sheetDataURL    = csvByGid("0");           // Shopper ID
            const sheetOverallURL = csvByGid("187588943");   // Partner ID
            const sheetClusterURL = csvByGid("1667516229");  // Cluster

            document.getElementById("mensaje").textContent = "Cargando datos...";

            const parseAndProcessData = (url, label) => {
                return new Promise((resolve, reject) => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: "greedy",
                        complete: function(results) {
                            if (results.errors && results.errors.length) {
                                safeWarn(label || 'FUENTE', `filas con problemas: ${results.errors.length}`);
                            }
                            const processedData = results.data.map(row => {
                                const newRow = {};
                                for (const key in row) {
                                    newRow[key + '_display'] = row[key];
                                    newRow[key] = normalizeString(row[key]);
                                }
                                return newRow;
                            }).filter(row => {
                                return Object.keys(row).some(key =>
                                    key.endsWith('_display') &&
                                    row[key] !== null &&
                                    row[key] !== undefined &&
                                    row[key].toString().trim() !== ''
                                );
                            });
                            resolve(processedData);
                        },
                        error: function(err) {
                            safeError(label || 'FUENTE', err);
                            // Rechazamos con un mensaje sin URL
                            reject(new Error(`No se pudo cargar la fuente ${label || 'de datos'}.`));
                        }
                    });
                });
            };

            Promise.all([
                parseAndProcessData(sheetDataURL, "DATA"),
                parseAndProcessData(sheetOverallURL, "OVERALL"),
                parseAndProcessData(sheetClusterURL, "CLUSTERS")
            ])
            .then(([res1, res2, res3]) => {
                data = res1.filter(r => r.country_name && r.partner_name && r.semana && r.shopper_name);
                overall = res2.filter(r => r.country_name && r.partner_name && r.semana);
                clusterData = res3.filter(r => r.country_name && r.cluster_name);
                
                aplicarFiltros();
                ["franquicia", "sucursal", "semana", "shopper"].forEach(id => {
                    document.getElementById(id).addEventListener("change", aplicarFiltros);
                });
                document.getElementById("mensaje").textContent = "Datos cargados correctamente.";
            })
            .catch(() => {
                // Mensaje visible al usuario SIN URLs
                document.getElementById("mensaje").textContent = "Error crítico al cargar datos. Reintentá en unos minutos.";
                safeError('Promise.all', 'Fallo de carga de una o más fuentes');
            });
        }
    </script>
</body>
</html>











