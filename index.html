<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Reporte de Performance - PedidosYa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet" />
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3P5PS1Z78W"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());

  (function () {
    const esProd = location.hostname === 'performance-shopper.vercel.app';
    if (esProd) {
      gtag('config', 'G-3P5PS1Z78W');
    } else {
      console.log('[GA4] Desactivado en entorno no productivo:', location.hostname);
    }
  })();
</script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; margin: 0; background: #f4f4f4; color: #100423; }
        .container { max-width: 960px; margin: 2rem auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h2 { color: #ea044e; text-align: center; margin-bottom: 1.5rem; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333; }
        select, input, button { width: calc(100% - 22px); margin: 10px 0; padding: 10px; font-family: inherit; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { background: #ea044e; color: white; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.3s ease; }
        button:hover { background: #d40344; }
        .card { border: 2px solid #ccc; padding: 20px; margin: 20px 0; border-radius: 10px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .oro { background: #fff4cc; border-color: #ffcc00; }
        .plata { background: #cfe2f3; border-color: #6cbde2; }
        .bronce { background: #f2e2d2; border-color: #d18d42; }
        .critico { background: #f8d7da; border-color: #dc3545; }
        .hidden { display: none; }
        strong { display: inline-block; width: 180px; }
        h3 { color: #100423; margin-top: 0; margin-bottom: 1em; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        h4 { margin-top: 1.5em; margin-bottom: 0.5em; color: #000; font-size: 1rem; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 4px; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        table th, table td { border: 1px solid #ddd; padding: 12px 8px; text-align: center; vertical-align: middle; }
        table th { background: #e9ecef; font-weight: 700; color: #495057; }
        table tr:nth-child(even) { background-color: #f8f9fa; }
        table tr:hover { background-color: #f1f1f1; }
        mensaje { color: #ea044e; text-align: center; font-weight: 600; margin-top: 15px; }
        .op-block { margin: 12px 0 4px; }
        .op-label { font-weight: 700; margin-bottom: 6px; }
        .op-pillar { margin: 10px 0 14px; }
        .op-title { font-weight: 700; color:#100423; margin-bottom: 6px; display:flex; align-items:center; gap:8px; }
        .op-ico { width: 1.25rem; display:inline-block; text-align:center; }
        .op-list { margin: 0; padding-left: 22px; }
        .op-list li { margin: 3px 0; text-align: left; }
        .card ul { margin:0; }
        .delta { font-weight: 700; margin-left: 4px; }
        .delta.good { color: #0a8f3d; }
        .delta.bad  { color: #c0392b; }

        .banner-info {
          margin: 12px 0 18px;
          padding: 12px 14px;
          border-radius: 10px;
          background: #EAF7EE; /* Verde claro*/
          border: 1px solid #B8E1C6;
          color: #215A36; /* Texto oscuro */
          font-weight: 600;
        }
        .banner-info a { color: #0F5132; text-decoration: underline; }
        .banner-info strong { width: auto; display: inline; }

        /* ESTILOS PARA BANNER PODIO PANAM√Å */
        .banner-podio {
          margin: 12px 0 18px;
          padding: 12px 14px;
          border-radius: 10px;
          background: #f0f0f0;
          border: 1px solid #d0d0d0;
          color: #333333;
          font-weight: 600;
        }
        .banner-podio a { color: #555555; text-decoration: underline; }
        .banner-podio strong { width: auto; display: inline; }

        /* ESTILOS PARA BANNER POR PA√çS (ACTIVO) */
        .banner-especifico {
          margin: 12px 0 18px;
          padding: 12px 14px;
          border-radius: 10px;
          background: #eaf7ee;
          border: 1px solid #b8e1c6;
          color: #215a36;
          font-weight: 600;
        }
        .banner-especifico a { color: #0f5132; text-decoration: underline; }
        .banner-especifico strong { width: auto; display: inline; }
    </style>
</head>
<body>
    <div class="container" id="login">
        <h2>Acceso al Reporte</h2>
        <input type="text" id="usuario" placeholder="Usuario" />
        <input type="password" id="contrasena" placeholder="Contrase√±a" />
        <button onclick="validarLogin()">Ingresar</button>
        <p id="error" style="color: red; text-align: center; margin-top: 10px;"></p>
    </div>

    <div class="container hidden" id="app">
        <h2>Reporte de Performance</h2>

        <!-- Desactivado temporalmente: Top Shoppers Panam√° -->
        <div id="bannerpodio" class="banner-podio hidden"></div>

        <!-- Activo: Novedad / mensajes por pa√≠s -->
        <div id="bannerPaisEspecifico" class="banner-especifico hidden"></div>

        <label for="pais">Pa√≠s</label>
        <select id="pais" disabled><option value="">Seleccionar</option></select>
        
        <label for="franquicia">Franquicia</label>
        <select id="franquicia"><option value="">Seleccionar</option></select>
        
        <label for="sucursal">Sucursal</label>
        <select id="sucursal"><option value="">Seleccionar</option></select>
        
        <label for="semana">Semana</label>
        <select id="semana"><option value="">Seleccionar</option></select>
        
        <label for="shopper">Shopper</label>
        <select id="shopper"><option value="">Todos</option></select>
        
        <p id="mensaje"></p>
        
        <div id="cortes"></div>
        <div id="overallScore" class="card hidden"></div>
        <div id="resultado"></div>
    </div>

    <script>
        /* ========= Helpers de URLs ========= */
        const SHEET_DOC_ID = "1jA3czu0ZOQdV0d7HF4dN2xxTPmi2a-zUdCmKNVG2hgg";
        const csvByGid = (gid) =>
          `https://docs.google.com/spreadsheets/d/${SHEET_DOC_ID}/export?format=csv&gid=${gid}&_=${Date.now()}`;
        /* =================================== */

        let userPaisDisplayName = ""; 
        let userPaisNormalized = ""; 
        let data = [], overall = [], clusterData = [];

        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
        }

        /* ==== Sanitizaci√≥n y logging seguro ==== */
        const URL_RE = /https?:\/\/[^\s)]+/g;
        function sanitize(text) { return String(text || '').replace(URL_RE, '[URL oculta]'); }
        function safeWarn(label, details) { try { console.warn(`Aviso en ${label}`, sanitize(details)); } catch(_){} }
        function safeError(label, err) {
          try {
            const msg = err && (err.stack || err.message || String(err));
            console.error(`Error en ${label}:`, sanitize(msg));
          } catch(_) {}
        }
        window.addEventListener('error', (e) => { safeError('GLOBAL', e?.error || e?.message || 'Error'); });
        window.addEventListener('unhandledrejection', (e) => { safeError('GLOBAL Promise', e?.reason || 'Rechazo no manejado'); });

        /* ==== Utilidades de lectura/variaciones ==== */
        function escapeHTML(s='') {
          return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
        }
        function getVal(row, keys, fallback='-') {
          for (const k of keys) {
            const v = row[k + '_display'];
            if (v !== undefined && v !== null && String(v).trim() !== '') return v;
          }
          return fallback;
        }
        const DELTA_RULE = {
          var_shopper_scoring: 'upGood',
          var_timing_compliance: 'upGood',
          var_picking_compliance: 'upGood',
          var_quality_compliance: 'upGood',
          var_rep_sent: 'upGood',
          var_rep_rate: 'upGood',
          var_first_prod_time_puntos: 'downGood',
          var_picking_time_puntos: 'downGood',
          var_VFR: 'downGood',
          var_OOS_FR: 'downGood',
          var_not_found_rate: 'downGood',
          var_missing_item: 'downGood',
          var_wrong_item: 'downGood',
          var_prod_quality: 'downGood',
          var_picking_late: 'downGood',
          var_first_prod_late: 'downGood',
        };
        const METRICAS_SIN_PORCENTAJE = new Set(['var_first_prod_time_puntos','var_picking_time_puntos']);

        function parseDeltaNumber(s) {
          if (s === null || s === undefined) return null;
          let t = String(s).trim().replace(/\u2212/g, '-').replace(',', '.');
          const m = t.match(/[-+]?(\d+(\.\d+)?)/);
          return m ? parseFloat(m[0]) : NaN;
        }

        function formatDelta(row, varKey) {
          const raw = row[varKey + '_display'];
          if (raw === undefined || raw === null || String(raw).trim() === '') return '';
          const n = parseDeltaNumber(raw);
          if (!isFinite(n)) return '';
          const sufijo = METRICAS_SIN_PORCENTAJE.has(varKey) ? '' : '%';
          const valorMostrado = escapeHTML(String(raw).trim()) + sufijo;
          if (n === 0) return ` <span class="delta">(‚Üî ${valorMostrado})</span>`;
          const rule = DELTA_RULE[varKey] || 'upGood';
          const isUp = n > 0;
          const isGood = rule === 'downGood' ? (n < 0) : (n > 0);
          const arrow = isUp ? '‚Üë' : '‚Üì';
          const cls = isGood ? 'good' : 'bad';
          return ` <span class="delta ${cls}">(${arrow} ${valorMostrado})</span>`;
        }

        const USERS = {
            "argentina": { user: "arg", pass: "arg" },
            "bolivia": { user: "bol", pass: "bol" },
            "guatemala": { user: "gua", pass: "gua" },
            "honduras": { user: "hon", pass: "hon" },
            "panam√°": { user: "pan", pass: "pan" },
            "per√∫": { user: "per", pass: "per" },
            "Rep√∫blica Dominicana": { user: "rep", pass: "rep" },
            "ecuador": { user: "ecu", pass: "ecu" },
            "uruguay": { user: "uru", pass: "uru" },
             "nicaragua": { user: "nic", pass: "nic" },
            
        };

        // URL del instructivo (Drive)
        const PDF_URL = "https://drive.google.com/file/d/1F1TDRak4iPKly98hPAEZxMMQDIbp22cA/view";

        // Pa√≠ses EXCLUIDOS del banner (por si necesit√°s l√≥gica adicional)
        const EXCLUDED_BANNER = new Set(["panama", "republica dominicana"]);

        function showBannerpodio() {
          const el = document.getElementById("bannerpodio");
          if (!el) return;
              let content = null;
  let title = '';
         if (userPaisNormalized === "panama") {
        // 1. Definimos el t√≠tulo para que la l√≥gica final lo detecte
        title = 'üèÜ ¬°Top Shoppers Noviembre - Panam√°! üèÜ';
        
        // 2. Asignamos el contenido a la variable 'content'
        content = `
          <ol style="padding-left: 20px; margin: 0;">
            <li><strong>Sergio Pinto</strong> ‚Äì Supermercados Rey David ‚Äì 95.7 ü•á</li>
            <li><strong>Daniel Samudio</strong> ‚Äì Supermercados Rey David ‚Äì 95.2 ü•à</li>
            <li><strong>Jorge Aguilar</strong> ‚Äì Supermercados Rey David ‚Äì 94.8 ü•â</li>
          </ol>

          <div style="text-align: center; margin-top: 16px; margin-bottom: 12px;">
            <strong>Menciones Honor√≠ficas üèÖ</strong>
          </div>

          <ul style="padding-left: 20px; margin: 0; list-style-type: '‚Äì '; ">
            <li><strong>Isidro Dutary</strong> ‚Äì Supermercados Rey Costa del Este ‚Äì 95.9 üèÖ</li>
            <li><strong>Luis Osano</strong> ‚Äì Supermercados Rey David ‚Äì 95.5 üèÖ</li>
            <li><strong>Joseph Matheus</strong> ‚Äì Supermercados Rey Paseo Albrook ‚Äì 95.2 üèÖ</li>
            <li><strong>Sherlyn de la Rosa</strong> ‚Äì Supermercados Rey Centennial ‚Äì 95.2 üèÖ</li>
            <li><strong>Jos√© S√°nchez</strong> ‚Äì Supermercados Rey Costa Verde ‚Äì 94.9 üèÖ</li>
            <li><strong>Anthony De La Rosa</strong> ‚Äì Hiper Rey Los Pueblos ‚Äì 94.8 üèÖ</li>
            <li><strong>Bladimir Otero</strong> ‚Äì Supermercados Rey Centennial ‚Äì 94.8 üèÖ</li>
            <li><strong>Jose Espinosa</strong> ‚Äì Supermercados Rey Calle 50 ‚Äì 94.2 üèÖ</li>
          </ul>
        `;
      }
            if (content) {
¬† ¬† ¬† ¬† el.innerHTML = `<div style="text-align: center; margin-bottom: 12px;">${title}</div>${content}`;
¬† ¬† ¬† ¬† el.classList.remove("hidden");
¬† ¬† ¬† ¬† // Aseguramos que la clase 'banner-especifico' (verde) est√© removida en caso de conflicto
¬† ¬† ¬† ¬† el.classList.remove("banner-especifico"); 
¬† ¬† ¬† ¬† // La clase 'banner-podio' ya est√° en el HTML, no es necesario re-agregarla.
¬† ¬† } else {
¬† ¬† ¬† ¬† el.classList.add("hidden");
¬† ¬† }
}
        

        // Activo: Banner por pa√≠s
        function showBannerPaisEspecifico() {
          const el = document.getElementById("bannerPaisEspecifico");
          if (!el) return;
          const LINK_GENERAL = "https://drive.google.com/file/d/1PA_KcST20OiHI31W9nqcj1VdBhS6xMWC/view?usp=sharing"; 

          const MENSAJES_POR_PAIS = {
            "panama": `
              <strong>üÜï Novedad solo para Shoppers de Rey Calle 50 y Rey Costa del Este!</strong> 
              <div style="margin-top: 8px;">A partir del Lunes 20/11 los clientes van a poder enviarte ‚ÄúNotas‚Äù en frutas y verduras para que puedas elegir mejor seg√∫n sus preferenciasüçéüçå
              <div style="margin-top: 8px;"><a href="${LINK_GENERAL}" target="_blank">üëâLe√© el manual sobre este cambio aqu√≠</a>.
            `,
              "argentina": `
  <strong>üÜï Novedad importante</strong>

  <div style="margin-top:8px;">
    Desde el Lunes 15/12 sumamos ‚ÄúNotas‚Äù en frutas y verduras para mejorar la elecci√≥n seg√∫n las preferencias del cliente üçéüçå
  </div>

  <div style="margin-top:10px;">
    En Argentina se incorporan <strong>51 tiendas</strong>.  
    Es fundamental que verifiques si tu tienda est√° incluida en la lista  
    y que leas el <strong>protocolo obligatorio</strong> para aplicar las notas correctamente.
  </div>

  <div style="margin-top:10px;">
    <a href="https://drive.google.com/file/d/1re9N2mSd0AQLw9r6IbewpWqkRE_GgY9C/view?usp=sharing"
       target="_blank" rel="noopener">
      üëâ Revis√° ac√° el listado de tiendas y el manual obligatorio
    </a>
  </div>
`,    
            "peru": `
              <strong>üÜï Novedad solo para Shoppers de Tottus y Tottus La Marina</strong> 
              <div style="margin-top: 8px;">A partir del Lunes 20/10 los clientes van a poder enviarte ‚ÄúNotas‚Äù en frutas y verduras para que puedas elegir mejor seg√∫n sus preferenciasüçéüçå
              <div style="margin-top: 8px;"><a href="${LINK_GENERAL}" target="_blank">üëâLe√© el manual sobre este cambio aqu√≠</a>.
            `
          };

          const mensaje = MENSAJES_POR_PAIS[userPaisNormalized];
          if (mensaje) {
            el.innerHTML = mensaje;
            el.classList.remove("hidden");
          } else {
            el.classList.add("hidden");
          }
        }

        function validarLogin() {
            const u = document.getElementById("usuario").value.toLowerCase();
            const p = document.getElementById("contrasena").value.toLowerCase();
            const found = Object.entries(USERS).find(([paisKey, cred]) => {
                return normalizeString(cred.user) === normalizeString(u) && normalizeString(cred.pass) === normalizeString(p);
            });

            if (found) {
                userPaisDisplayName = found[0]; 
                userPaisNormalized = normalizeString(found[0]); 

                document.getElementById("login").classList.add("hidden");
                document.getElementById("app").classList.remove("hidden");
                document.getElementById("pais").innerHTML = `<option value="${userPaisDisplayName}">${userPaisDisplayName}</option>`;

                // Banner Panam√° desactivado:
                showBannerpodio();

                // Banner por pa√≠s activo:
                showBannerPaisEspecifico();

                cargarDatos();
            } else {
                document.getElementById("error").textContent = "Credenciales incorrectas";
            }
        }

        /* ========== Render de Oportunidades ========== */
        function getPillarIcon(title) {
          const t = (title||'').toLowerCase();
          if (t.includes('picking')) return 'üõí';
          if (t.includes('tiempos')) return '‚è±Ô∏è';
          return '‚úÖ';
        }

        function renderOportunidadHTML(raw) {
          if (!raw || /sin desvio|sin desv√≠o|sin desv√≠os/i.test(raw)) {
            return '<div class="op-block"><div class="op-label">Puntos a Mejorar:</div><em>Sin desv√≠os relevantes</em></div>';
          }
          let text = String(raw).replace(/<br\s*\/?>/gi, '\n').replace(/\r/g, '').trim();
          const pillarChunks = text.split(/\s*\|\s*|\n{2,}/).map(x => x.trim()).filter(Boolean);
          const looksLikePillars = pillarChunks.some(p => /^(\s*)?(Picking|Tiempos|Calidad)\s*:/i.test(p));
          if (!looksLikePillars) {
            return `<div class="op-block"><div class="op-label">Puntos a Mejorar:</div>${escapeHTML(text).replace(/\n/g,'<br>')}</div>`;
          }
          const htmlPillars = pillarChunks.map(chunk => {
            const m = chunk.match(/^\s*(Picking|Tiempos|Calidad)\s*:\s*(.*)$/i);
            if (!m) return '';
            const title = m[1];
            const body  = m[2] || '';
            const items = body.split(/;|\n/).map(s => s.replace(/^‚Ä¢\s*/,'').trim()).filter(Boolean);
            const li = items.map(it => `<li>${escapeHTML(it)}</li>`).join('');
            const list = li ? `<ul class="op-list">${li}</ul>` : `<ul class="op-list"><li>Por debajo del m√≠nimo de ${title.toLowerCase()}</li></ul>`;
            return `<div class="op-pillar"><div class="op-title"><span class="op-ico">${getPillarIcon(title)}</span>${title}</div>${list}</div>`;
          }).join('');
          return `<div class="op-block"><div class="op-label">Puntos a Mejorar:</div>${htmlPillars}</div>`;
        }

        function aplicarFiltros() {
            const franquicia = document.getElementById("franquicia").value;
            const sucursal = document.getElementById("sucursal").value;
            const semana = document.getElementById("semana").value;
            const shopper = document.getElementById("shopper").value;
            
            const normalizedFranquicia = normalizeString(franquicia);
            const normalizedSucursal = normalizeString(sucursal);
            const normalizedSemana = normalizeString(semana);
            const normalizedShopper = normalizeString(shopper);
            
            const filteredDataForFranchise = data.filter(r => r.country_name === userPaisNormalized);
            const franquicias = new Set(filteredDataForFranchise.map(r => r.franchise_name_display).filter(Boolean));
            actualizarSelect("franquicia", franquicias);

            const filteredDataForSucursal = filteredDataForFranchise.filter(r =>
                (!franquicia || r.franchise_name === normalizedFranquicia)
            );
            const sucursales = new Set(filteredDataForSucursal.map(r => r.partner_name_display).filter(Boolean));
            actualizarSelect("sucursal", sucursales);

            const filteredDataForSemana = filteredDataForSucursal.filter(r =>
                (!sucursal || r.partner_name === normalizedSucursal)
            );
            const semanas = new Set(filteredDataForSemana.map(r => r.semana_display).filter(Boolean));
            actualizarSelect("semana", semanas);

            const filteredDataForShopper = filteredDataForSemana.filter(r =>
                (!semana || r.semana === normalizedSemana)
            );
            const shoppers = new Set(filteredDataForShopper.map(r => r.shopper_name_display).filter(Boolean));
            actualizarSelect("shopper", shoppers, true);

            mostrarCortes();
            mostrarResultados();
        }

        function actualizarSelect(id, valores, incluirTodos = false) {
            const el = document.getElementById(id);
            const actualValue = el.value;
            const normalizedActualValue = normalizeString(actualValue);
            el.innerHTML = incluirTodos ? `<option value="">Todos</option>` : `<option value="">Seleccionar</option>`;
            [...valores].sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b, undefined, {sensitivity: 'base'});
            }).forEach(v => {
                const o = document.createElement("option");
                o.value = v; o.textContent = v; el.appendChild(o);
            });
            const optionExists = Array.from(el.options).some(opt => normalizeString(opt.value) === normalizedActualValue);
            if (optionExists) el.value = actualValue;
            else if (incluirTodos && normalizedActualValue === '') el.value = "";
            else el.value = el.options[0].value;
        }

        function mostrarResultados() {
            const franquicia = document.getElementById("franquicia").value;
            const sucursal = document.getElementById("sucursal").value;
            const semana = document.getElementById("semana").value;
            const shopper = document.getElementById("shopper").value;

            const cont = document.getElementById("resultado");
            const msg = document.getElementById("mensaje");
            const overallScoreDiv = document.getElementById("overallScore");
            
            cont.innerHTML = "";
            msg.textContent = "";
            overallScoreDiv.classList.add("hidden");

            const normalizedFranquicia = normalizeString(franquicia);
            const normalizedSucursal = normalizeString(sucursal);
            const normalizedSemana = normalizeString(semana);
            const normalizedShopper = normalizeString(shopper);

            if (!sucursal || !semana) {
                msg.textContent = "Complet√° los filtros de Sucursal y Semana para ver resultados.";
                return;
            }

            /* -------- Tarjeta OVERALL (tienda) -------- */
            const storeOverall = overall.find(r =>
                r.country_name === userPaisNormalized &&
                r.partner_name === normalizedSucursal &&
                r.semana === normalizedSemana &&
                (!franquicia || r.franchise_name === normalizedFranquicia)
            );

            if (storeOverall) {
                const oppOverallHTML = renderOportunidadHTML(storeOverall.oportunidad_de_mejora_display || '');
                overallScoreDiv.innerHTML = `
                <h3>Puntaje General de la Tienda (${storeOverall.partner_name_display || '-'})</h3>
                <p><strong>Puntaje:</strong> ${getVal(storeOverall, ['shopper_scoring'])}${formatDelta(storeOverall, 'var_shopper_scoring')}</p>
                <p><strong>Posici√≥n:</strong> ${storeOverall.cluster_name_final_display || '-'}</p>
                <p><strong>√ìrdenes canceladas:</strong> ${getVal(storeOverall, ['VFR'])}${formatDelta(storeOverall, 'var_VFR')}</p>
                ${oppOverallHTML}
                
                <h4>TIEMPOS</h4>
                <p><strong>Puntaje Tiempos:</strong> ${getVal(storeOverall, ['timing_compliance'])}${formatDelta(storeOverall, 'var_timing_compliance')}</p>
                <p><strong>Tiempo por orden:</strong> ${getVal(storeOverall, ['picking_time'])}${formatDelta(storeOverall, 'var_picking_time_puntos')}</p>
                <p><strong>%√ìrdenes tarde:</strong> ${getVal(storeOverall, ['picking_late'])}${formatDelta(storeOverall, 'var_picking_late')}</p>
                <p><strong>Tiempo en encontrar primer item:</strong> ${getVal(storeOverall, ['first_prod_time'])}${formatDelta(storeOverall, 'var_first_prod_time_puntos')}</p>
                <p><strong>%Primer item encontrado > 3':</strong> ${getVal(storeOverall, ['first_prod_late'])}${formatDelta(storeOverall, 'var_first_prod_late')}</p>
                
                <h4>PICKING</h4>
                <p><strong>Puntaje Picking:</strong> ${getVal(storeOverall, ['picking_compliance'])}${formatDelta(storeOverall, 'var_picking_compliance')}</p>
                <p><strong>%Cancelaciones por falta de producto:</strong> ${getVal(storeOverall, ['OOS_FR'])}${formatDelta(storeOverall, 'var_OOS_FR')}</p>
                <p><strong>%Productos no encontrados:</strong> ${getVal(storeOverall, ['not_found_rate'])}${formatDelta(storeOverall, 'var_not_found_rate')}</p>
                <p><strong>%Reemplazos enviados:</strong> ${getVal(storeOverall, ['rep_sent'])}${formatDelta(storeOverall, 'var_rep_sent')}</p>
                <p><strong>%Reemplazos aceptados:</strong> ${getVal(storeOverall, ['rep_rate'])}${formatDelta(storeOverall, 'var_rep_rate')}</p>
                
                <h4>CALIDAD</h4>
                <p><strong>Puntaje Calidad:</strong> ${getVal(storeOverall, ['quality_compliance'])}${formatDelta(storeOverall, 'var_quality_compliance')}</p>
                <p><strong>%Falta producto:</strong> ${getVal(storeOverall, ['missing_item'])}${formatDelta(storeOverall, 'var_missing_item')}</p>
                <p><strong>%Producto en mal estado:</strong> ${getVal(storeOverall, ['prod_quality'])}${formatDelta(storeOverall, 'var_prod_quality')}</p>
                <p><strong>%Producto equivocado:</strong> ${getVal(storeOverall, ['wrong_item'])}${formatDelta(storeOverall, 'var_wrong_item')}</p>
              `;
                overallScoreDiv.classList.remove("hidden");
                overallScoreDiv.classList.remove("oro", "plata", "bronce", "critico");
                const colorClase = getColor(storeOverall.cluster_name_final_display);
              if (colorClase) {
               overallScoreDiv.classList.add(colorClase);
}
            } else {
                overallScoreDiv.classList.add("hidden");
            }

            /* -------- Cards de SHOPPERS -------- */
            const filtrados = data.filter(r => {
                return r.country_name === userPaisNormalized &&
                       (!franquicia || r.franchise_name === normalizedFranquicia) &&
                       r.partner_name === normalizedSucursal &&
                       r.semana === normalizedSemana &&
                       (shopper === "" || r.shopper_name === normalizedShopper);
            });

            if (filtrados.length === 0 && !storeOverall) {
                msg.textContent = "No se encontraron resultados para los filtros seleccionados.";
                return;
            }

            if (shopper !== "") {
              const shopperData = filtrados.find(r => r.shopper_name === normalizedShopper);
              if (shopperData) {
                cont.appendChild(crearCard(shopperData, shopperData.shopper_name_display));
              } else {
                msg.textContent = "No se encontraron datos para el shopper seleccionado.";
              }
            } else {
              filtrados.forEach(r => cont.appendChild(crearCard(r, r.shopper_name_display)));
            }
        }

        function crearCard(r, titulo) {
            const div = document.createElement("div");
            div.className = "card " + getColor(r.cluster_name_final_display);
            const oppHTML = renderOportunidadHTML(r.oportunidad_de_mejora_display || '');

            div.innerHTML = `
                <h3>${titulo || '-'}</h3>
                <p><strong>Puntaje:</strong> ${getVal(r, ['shopper_scoring'])}${formatDelta(r, 'var_shopper_scoring')}</p>
                <p><strong>Posici√≥n:</strong> ${r.cluster_name_final_display || '-'}</p>
                <p><strong>Nivel de Experiencia:</strong> ${r.nivel_experiencia_display || '-'}</p>
                ${oppHTML}
                <p><strong>Semana:</strong> ${r.semana_display || '-'}</p>

                <h4>TIEMPOS</h4>
                <p><strong>Puntaje Tiempos:</strong> ${getVal(r, ['timing_compliance'])}${formatDelta(r, 'var_timing_compliance')}</p>
                <p><strong>Tiempo por orden:</strong> ${getVal(r, ['picking_time'])}${formatDelta(r, 'var_picking_time_puntos')}</p>
                <p><strong>%√ìrdenes tarde:</strong> ${getVal(r, ['picking_late'])}${formatDelta(r, 'var_picking_late')}</p>
                <p><strong>Tiempo en encontrar primer item:</strong> ${getVal(r, ['first_prod_time'])}${formatDelta(r, 'var_first_prod_time_puntos')}</p>
                <p><strong>%Primer item encontrado > 3':</strong> ${getVal(r, ['first_prod_late'])}${formatDelta(r, 'var_first_prod_late')}</p>

                <h4>PICKING</h4>
                <p><strong>Puntaje Picking:</strong> ${getVal(r, ['picking_compliance'])}${formatDelta(r, 'var_picking_compliance')}</p>
                <p><strong>%Cancelaciones por falta de producto:</strong> ${getVal(r, ['OOS_FR'])}${formatDelta(r, 'var_OOS_FR')}</p>
                <p><strong>%Productos no encontrados:</strong> ${getVal(r, ['not_found_rate'])}${formatDelta(r, 'var_not_found_rate')}</p>
                <p><strong>%Reemplazos enviados:</strong> ${getVal(r, ['rep_sent'])}${formatDelta(r, 'var_rep_sent')}</p>
                <p><strong>%Reemplazos aceptados:</strong> ${getVal(r, ['rep_rate'])}${formatDelta(r, 'var_rep_rate')}</p>

                <h4>CALIDAD</h4>
                <p><strong>Puntaje Calidad:</strong> ${getVal(r, ['quality_compliance'])}${formatDelta(r, 'var_quality_compliance')}</p>
                <p><strong>%Falta producto:</strong> ${getVal(r, ['missing_item'])}${formatDelta(r, 'var_missing_item')}</p>
                <p><strong>%Producto en mal estado:</strong> ${getVal(r, ['prod_quality'])}${formatDelta(r, 'var_prod_quality')}</p>
                <p><strong>%Producto equivocado:</strong> ${getVal(r, ['wrong_item'])}${formatDelta(r, 'var_wrong_item')}</p>
            `;
            return div;
        }

        function getColor(pos) {
            if (!pos) return '';
            const normalizedPos = normalizeString(pos);
            if (normalizedPos.includes("plata")) return "plata";
            if (normalizedPos.includes("oro")) return "oro";
            if (normalizedPos.includes("bronce")) return "bronce";
            if (normalizedPos.includes("critico") || normalizedPos.includes("cr√≠tico")) return "critico";
            return '';
        }

        function mostrarCortes() {
          const franquicia = document.getElementById("franquicia").value;
          const cont = document.getElementById("cortes");
          cont.innerHTML = "";

          if (!userPaisNormalized) return;

          let rows = [];
          let title = "";
          const normalizedFranquicia = normalizeString(franquicia);

          if (franquicia) {
            rows = clusterData.filter(r =>
              r.country_name === userPaisNormalized &&
              r.franchise_name === normalizedFranquicia
            );
            title = `Condiciones por Posici√≥n (${franquicia})`;
          }

          if (rows.length === 0) {
            rows = clusterData.filter(r =>
              r.country_name === userPaisNormalized &&
              (!r.franchise_name || r.franchise_name === "")
            );
            title = `Condiciones por Posici√≥n (${userPaisDisplayName})`;
          }

          if (!rows.length) {
            cont.innerHTML = "<p>No se encontraron condiciones de cortes para este pa√≠s o franquicia.</p>";
            return;
          }

          // T√≠tulo + subt√≠tulo
          let html = `
            <h3>${title}</h3>
            <p style="margin-top:-6px;font-size:0.95rem;color:#555;line-height:1.4;">
              Esta tabla muestra los valores m√≠nimos de desempe√±o que debe cumplir cada posici√≥n
              en Tiempos, Picking y Calidad. Si alguna de estas m√©tricas est√° por debajo del umbral, el shopper descender√° de posici√≥n
              incluso si su puntaje global se encuentra dentro del rango correspondiente.
            </p>
          `;

          html += `
            <table style="width:100%;">
              <thead>
                <tr>
                  <th>Posici√≥n</th>
                  <th>Puntaje</th>
                  <th>Tiempos M√≠nimo</th>
                  <th>Picking M√≠nimo</th>
                  <th>Calidad M√≠nimo</th>
                </tr>
              </thead>
              <tbody>
          `;

          rows.forEach(r => {
            html += `
              <tr>
                <td>${r.cluster_name_display || "-"}</td>
                <td>${(r.lower_bound_display ?? "-")} - ${(r.upper_bound_display ?? "-")}</td>
                <td>${r.min_timing_compliance_display || "-"}</td>
                <td>${r.min_picking_compliance_display || "-"}</td>
                <td>${r.min_quality_compliance_display || "-"}</td>
              </tr>
            `;
          });

          html += `</tbody></table>`;
          cont.innerHTML = html;
        }

        function cargarDatos() {
            const sheetDataURL    = csvByGid("0");           // Shopper ID
            const sheetOverallURL = csvByGid("187588943");   // Partner ID
            const sheetClusterURL = csvByGid("1667516229");  // Cluster

            document.getElementById("mensaje").textContent = "Cargando datos...";

            const parseAndProcessData = (url, label) => {
                return new Promise((resolve, reject) => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: "greedy",
                        complete: function(results) {
                            if (results.errors && results.errors.length) {
                                safeWarn(label || 'FUENTE', `filas con problemas: ${results.errors.length}`);
                            }
                            const processedData = results.data.map(row => {
                                const newRow = {};
                                for (const key in row) {
                                    newRow[key + '_display'] = row[key];
                                    newRow[key] = normalizeString(row[key]);
                                }
                                return newRow;
                            }).filter(row => {
                                return Object.keys(row).some(key =>
                                    key.endsWith('_display') &&
                                    row[key] !== null &&
                                    row[key] !== undefined &&
                                    row[key].toString().trim() !== ''
                                );
                            });
                            resolve(processedData);
                        },
                        error: function(err) {
                            safeError(label || 'FUENTE', err);
                            reject(new Error(`No se pudo cargar la fuente ${label || 'de datos'}.`));
                        }
                    });
                });
            };

            Promise.all([
                parseAndProcessData(sheetDataURL, "DATA"),
                parseAndProcessData(sheetOverallURL, "OVERALL"),
                parseAndProcessData(sheetClusterURL, "CLUSTERS")
            ])
            .then(([res1, res2, res3]) => {
                data = res1.filter(r => r.country_name && r.partner_name && r.semana && r.shopper_name);
                overall = res2.filter(r => r.country_name && r.partner_name && r.semana);
                clusterData = res3.filter(r => r.country_name && r.cluster_name);
                
                aplicarFiltros();
                ["franquicia", "sucursal", "semana", "shopper"].forEach(id => {
                    document.getElementById(id).addEventListener("change", aplicarFiltros);
                });
                document.getElementById("mensaje").textContent = "Datos cargados correctamente.";
            })
            .catch(() => {
                document.getElementById("mensaje").textContent = "Error cr√≠tico al cargar datos. Reintent√° en unos minutos.";
                safeError('Promise.all', 'Fallo de carga de una o m√°s fuentes');
            });
        }
    </script>
</body>
</html>















